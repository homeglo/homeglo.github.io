<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Adaptive Lighting – Pipeline Explorer (fixed-scale + brightness γ)</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body{font-family:sans-serif;margin:1.5rem;}
  h2{margin-top:0}
  .controls{display:grid;grid-template-columns:220px 1fr 45px;
            gap:6px;align-items:center;margin-bottom:1rem}
  input[type=range]{width:100%}
  label{font-size:.85rem}
  .stage{margin:1.75rem 0}
  .divider{font-size:2rem;text-align:center;margin:0.5rem 0}
</style>
</head>
<body>
<h2>Adaptive Lighting – Pipeline Explorer</h2>

<!-- STAGE 0 CONTROLS -------------------------------------------------->
<h3>Stage 0 • Base curve</h3>
<div id="ctrl-base" class="controls"></div>

<div id="plot0" class="stage"></div>

<div class="divider">↓</div>

<!-- STAGE 1 CONTROLS -------------------------------------------------->
<h3>Stage 1 • Lux filter (new γ curves)</h3>
<div id="ctrl-lux" class="controls"></div>

<div id="plot1" class="stage"></div>

<div class="divider">↓</div>

<!-- STAGE 2 (no controls) ------------------------------------------->
<h3>Stage 2 • Final (future filters)</h3>
<div id="plot2" class="stage"></div>

<script>
// -------------------------------------------------------------------
// Parameters (defaults)
// -------------------------------------------------------------------
const params={
  /* base-curve */
  min_color_temp:2000,max_color_temp:6500,
  min_brightness:1,max_brightness:100,
  gamma:2,                 // CCT gamma
  gamma_bri0:1.5,            // **NEW** brightness gamma for Stage 0

  /* lux */
  lux:1000,min_lux:10,max_lux:6000,
  gamma_bri:1.4,           // inverse-gamma for lux brightness dimming
  gamma_cct:1.0            // gamma for CCT smooth-step under lux
};

// Slider definitions per panel  [key, min, val, max, step]
const baseSliders=[
  ['gamma',0.2,2,3,0.1],
  ['gamma_bri0',0.5,1.5,3,0.1]   // brightness γ slider
];
const luxSliders=[
  ['lux',0,1000,10000,50],
  ['gamma_bri',0.5,1.4,3,0.1],
  ['gamma_cct',0.3,1,2,0.05]
];

// Build a slider panel ------------------------------------------------
function makePanel(containerId,sliderDefs){
  const wrap=t=>document.createElement(t);
  const panel=document.getElementById(containerId);
  sliderDefs.forEach(([key,min,val,max,step])=>{
    const lab=wrap('label'); lab.textContent=key;
    const rng=wrap('input');
    rng.type='range'; rng.min=min; rng.max=max; rng.step=step; rng.value=val;
    const out=wrap('span'); out.textContent=val;
    rng.oninput=e=>{params[key]=parseFloat(e.target.value);
                    out.textContent=e.target.value; draw();};
    panel.append(lab,rng,out);
    params[key]=val;
  });
}
makePanel('ctrl-base',baseSliders);
makePanel('ctrl-lux',luxSliders);

// -------------------------------------------------------------------
// Math helpers (same as prod, with **brightness γ** added)
// -------------------------------------------------------------------
function smoothstep(x){return x*x*(3-2*x);}  // cubic 0→1

function colorTemp(pos,min,max,g){
  let t=(pos+1)*0.5; if(g!==1) t=t**g;
  const s=smoothstep(t);
  return min+s*(max-min);
}

// Stage 0 brightness with gamma
function brightnessBase(pos,min,max,gamma){
  let t=(pos+1)*0.5; if(gamma!==1) t=t**gamma;
  const s=smoothstep(t);
  return min+s*(max-min);
}

// Linear normalisation of lux (0→1, clamped)
function luxNorm(lux,min,max){
  return Math.max(0, Math.min(1, (lux-min)/(max-min)));
}

// Apply new lux formula: inverse-gamma brightness + smooth-step CCT
function applyLux(cct,bri,lux,p){
  if(isNaN(lux)) return [cct,bri];
  const ln=luxNorm(lux,p.min_lux,p.max_lux);

  // Brightness factor (1→0 as lux rises)
  const briFactor=1-Math.pow(ln,p.gamma_bri);
  const bri2=Math.round(p.min_brightness + briFactor*(bri - p.min_brightness));

  // CCT mapping
  const t=smoothstep(ln);
  const cct2=Math.round(p.min_color_temp + Math.pow(t,p.gamma_cct)*(p.max_color_temp - p.min_color_temp));

  return [cct2,bri2];
}

const timeToPos=h=>-Math.cos((2*Math.PI*h)/24);

// -------------------------------------------------------------------
// Pipeline computation + plotting
// -------------------------------------------------------------------
function compute(){
  const h=[],c0=[],b0=[],c1=[],b1=[],c2=[],b2=[];
  for(let t=0;t<=24;t+=0.1){
    const pos=timeToPos(t);

    // Stage 0
    const baseC=colorTemp(pos,params.min_color_temp,params.max_color_temp,params.gamma);
    const baseB=brightnessBase(pos,params.min_brightness,params.max_brightness,params.gamma_bri0);

    // Stage 1 (lux filter)
    const [luxC,luxB]=applyLux(baseC,baseB,params.lux,params);

    // Stage 2 (placeholder)
    const finC=luxC, finB=luxB;

    h.push(t); c0.push(baseC); b0.push(baseB);
    c1.push(luxC); b1.push(luxB);
    c2.push(finC); b2.push(finB);
  }
  return{h,c0,b0,c1,b1,c2,b2};
}

function plot(divId,x,cct,bri,title){
  Plotly.newPlot(divId,[
    {x,y:cct,name:'CCT (K)',yaxis:'y1',line:{shape:'spline'}},
    {x,y:bri,name:'Brightness (%)',yaxis:'y2',line:{shape:'spline'}}
  ],{
    title,
    xaxis:{title:'Time of Day (h)',range:[0,24]},
    // **FIXED SCALE** for CCT so the axis no longer rescales on slider moves
    yaxis:{title:'Colour Temp (K)',range:[params.min_color_temp, params.max_color_temp],autorange:false},
    yaxis2:{title:'Brightness (%)',overlaying:'y',side:'right',range:[0,100],autorange:false}
  },{responsive:true});
}

function draw(){
  const {h,c0,b0,c1,b1,c2,b2}=compute();
  plot('plot0',h,c0,b0,'Stage 0 – Base curve');
  plot('plot1',h,c1,b1,'Stage 1 – After lux');
  // Future stages can be plotted similarly using c2/b2 etc.
}

draw();
</script>
</body>
</html>
